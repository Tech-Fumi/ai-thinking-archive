# AI 実行制御ポリシー

このファイルは **AI の実行権限・自動化範囲・危険操作の制御専用ファイル** です。
**人間のみが編集可能とし、AI による編集は禁止します。**

業務ルール・設計思想・仕様変更は必ず `../CLAUDE.md` に記載してください。

---

## 0. このファイルの絶対原則

- このファイルは **AI のブレーキと安全装置そのもの** である
- AI はこのファイルを **参照のみ可能・編集は禁止**
- 業務都合・仕様変更の理由で、このファイルの内容を緩和してはならない
- 変更が発生する場合は **人間が理由を明記して手動変更する**

---

## 1. 絶対禁止コマンド（無条件ブロック）

以下のコマンドは **いかなる理由でも実行禁止**：

```
rm -rf /
rm -rf ~
rm -rf .
git push --force
git push -f
git reset --hard（確認なし）
DROP DATABASE
DROP TABLE
TRUNCATE TABLE
```

---

## 2. 確認必須コマンド（フルオート対象外）

以下は **必ず人間の明示的な確認が必要**：

- `rm -rf <ディレクトリ>`（空でないディレクトリ）
- `git push`
- `git rebase`
- `git merge`（競合の可能性がある場合）
- 本番環境への接続・操作
- DB スキーマ変更（ALTER, DROP）
- デプロイ操作

---

## 3. 削除・変更禁止ファイル／ディレクトリ

以下は **AI による削除・変更を禁止**：

- `.git/`
- `.env`, `.env.*`
- `.claude/CLAUDE.md`（このファイル）
- `.claude/settings.json`
- `.github/workflows/`
- `terraform/`, `*.tf`
- `docker-compose.yml`
- 本番用設定ファイル一式

---

## 4. シークレット・環境変数保護

- `.env` の内容を **ログ・出力に含めない**
- APIキー・トークンを **平文表示しない**
- シークレットを含むファイルを **git add しない**
- CLAUDE.md に **シークレットの実値を絶対に書かない**

---

## 5. 本番環境の絶対制限

- 本番 DB への **直接接続・直接書き込みは禁止**
- 本番デプロイは **CI/CD 経由のみ**
- 本番ログは **読み取り専用**

---

## 6. フルオート実行モード（優先度制御）

本プロジェクトでは、以下の条件を満たす作業については
**AI はユーザー確認なしで自動実行してよい。**

### 6-1. 優先度付きフルオート実行ルール

**あらかじめ優先度が定義されているタスク**については、
AI は確認なしで **優先度の高い順に自動処理してよい。**

対象例：

- 監査ツールが検出した WARN / ERROR の修正
- CI 失敗要因の修正
- フォーマット・lint・型エラー修正
- テスト失敗の修正
- 明確な指示に基づくリファクタリング

適用条件：

- 優先度が **数値または明確な順序で定義されていること**
- 修正対象が **src/, docs/, tests/ 配下のみであること**
- 禁止コマンド・削除禁止ファイルに **影響しないこと**

### 6-2. 「提案型タスク」のみ確認を取る

以下のケースのみ、AI は **実行前に必ず確認を取る**：

- 新機能の追加提案
- 既存アーキテクチャの変更提案
- 処理フロー・責務分担の変更提案
- 新しい MCP の導入提案
- 大規模なファイル構成の変更

判断基準：

- ✅ 「決まっている作業を前に進める」→ 自動実行可
- ❌ 「今の仕様を変える／改善する」→ 必ず確認

### 6-3. フルオートでも禁止される操作

フルオート実行モードであっても、以下は **常にブロック**：

- `rm -rf` 全般
- `git push --force`
- `.env` 系ファイルの編集
- CI/CD 設定の改変
- インフラ定義の変更
- `.claude/CLAUDE.md` の編集

### 6-4. フルオート実行ログの義務化

フルオートで処理した場合、必ず以下を出力すること：

- 実行したタスク一覧
- 処理した順番（優先度順）
- 変更したファイル一覧
- スキップした危険操作の有無

出力フォーマット例：

```
[フルオート実行レポート]
- 優先度1: lint 修正 → 完了
- 優先度2: テスト失敗修正 → 完了
- 優先度3: 型エラー修正 → 完了
- 危険操作のスキップ: なし
```

---

## 7. AI に編集を許可するファイル範囲

AI が編集してよいファイル：

- `src/` 配下のソースコード
- `docs/` 配下のドキュメント
- `tests/` 配下のテストコード
- `../CLAUDE.md`（業務ルール）
  ※ ただし **原則「差分提案 → 人間確認 → 反映」方式**

---

## 8. このポリシー違反が検出された場合

- 即全自動実行を停止
- 人間によるルール再確認を実施
- 監査ツール（`audit_claude_md.py`）を即時再実行
